#/bin/bash

#########################################################################################################################
# Usage:  enum-dbms connectionName username password                                                                    #
#                                                                                                                       #
# username is in the form domain\\username
#                                                                                                                       #
# Don't forget to configure the SQL server in the /etc/freetds/freetds.conf file:                                       #
#      [ConnectionName]    ** NOTE: This is the name used as the first argument for this script                         #
#        host = 10.21.210.68                                                                                            #
#        port = 1433                                                                                                    #
#        tds version = 8.0                                                                                              #
#                                                                                                                       #
#                                                                         Timothy McKenzie 20141218                     #
#########################################################################################################################

for m in $(sqsh -S$1 -U$2 -P$3 -C"SELECT NAME FROM sys.sysdatabases;" | sed -e ':a;N;$!ba;s/\(\S\)\(\n\)\(\S\)/\1\3/g' -e ':a;N;$!ba;s/  \n//g' -e 's/  //g' | grep -wiv 'master\|tempdb\|model\|msdb\|row affected\|rows affected\|name\|---')

  do 
    sleep 1s
    echo Database $m...
    for p in $(sqsh -S$1 -U$2 -P$3 -C"use $m; SELECT name FROM sys.tables;" | sed -e ':a;N;$!ba;s/\(\S\)\(\n\)\(\S\)/\1\3/g' -e ':a;N;$!ba;s/  \n//g' -e 's/  //g' | grep -wiv 'row affected\|rows affected\|name\|---')
      do 
        sleep 1s
        echo $'\n\t'Table $p...
        echo -n $'\t\t'"Number of rows: "
        sqsh -S$1 -U$2 -P$3 -C"USE $m; SELECT COUNT(*) FROM $p;" | sed -e ':a;N;$!ba;s/\(\S\)\(\n\)\(\S\)/\1\3/g' -e ':a;N;$!ba;s/  \n//g' -e 's/  //g' | grep -wiv 'row affected\|rows affected\|name\|---'
        sleep 1s
        for s in $(sqsh -S$1 -U$2 -P$3 -C"use $m; SELECT name FROM syscolumns WHERE id=OBJECT_ID('$p')" | sed -e ':a;N;$!ba;s/\(\S\)\(\n\)\(\S\)/\1\3/g' -e ':a;N;$!ba;s/  \n//g' -e 's/  //g' | grep -wiv 'row affected\|rows affected\|name\|---')
          do 
            echo $'\t\t'$s
        done
    done
done
